{% extends "index.html" %}
{% import "discussion_macros.html" as discussion_macros %}

{% block title %} {{ config.title }} | {{ page.title }} {% endblock title %}

{% block content %}
    {# Discussion link at the top #}
    {% if page.extra.discussion_url %}
        {% if page.extra.enable_discussions is not defined or page.extra.enable_discussions != false %}
        <div class="discussion-nav">
            <a href="{{ page.extra.discussion_url }}" target="_blank" rel="noopener" class="discussion-link">
                <svg class="github-logo" height="16" width="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                </svg>
                Discuss on GitHub
            </a>
        </div>
        {% endif %}
    {% endif %}

    {{ page.content | safe }}

    {# Always show discussion section if discussion_url exists and not explicitly disabled #}
    {% if page.extra.discussion_url %}
        {% if page.extra.enable_discussions is not defined or page.extra.enable_discussions != false %}
        
        {# Try to load discussion data if available #}
        {% if page.extra.discussion_number %}
            {% set discussion_number = page.extra.discussion_number %}
            {% set comment_file = "data/discussion_comments/" ~ discussion_number ~ ".json" %}
            {% set discussion_data = load_data(path=comment_file, required=false) %}
            {% if discussion_data %}
                {% set discussions = load_data(path="data/discussions.json", required=false) %}
                {% set page_path = page.path | trim_end_matches(pat="/") %}
                {% set discussion_meta = discussions[page_path] | default(value=discussion_data.discussion) %}
                {% if not discussion_meta.url %}
                    {% set discussion_meta = discussion_data.discussion %}
                {% endif %}
                {% include "discussion_footer.html" %}
            {% else %}
                {# Fallback to placeholder if file missing #}
                <div class="discussion-footer">
                    <h3>Discussion</h3>
                    <p class="discussion-cta">
                        <a href="{{ page.extra.discussion_url }}" target="_blank" rel="noopener" class="github-discussion-link">
                            <svg class="github-logo" height="16" width="16" viewBox="0 0 16 16" fill="currentColor">
                                <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                            </svg>
                            Discuss on GitHub
                        </a>
                    </p>
                </div>
            {% endif %}
        {% else %}
            {# Show placeholder discussion section #}
            <div class="discussion-footer">
                <h3>Discussion</h3>
                <p class="discussion-cta">
                    <a href="{{ page.extra.discussion_url }}" target="_blank" rel="noopener" class="github-discussion-link">
                        <svg class="github-logo" height="16" width="16" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                        Discuss on GitHub
                    </a>
                </p>
            </div>
        {% endif %}
        {% endif %}
    {% endif %}
{% endblock content %}

{% block rss %}
    {{ super() }}
    {% include "head_meta.html" %}
    {% include "additional_meta.html" %}
    {% include "bluesky_meta.html" %}
    {% include "enhanced_structured_data.html" %}
{% endblock rss %}
